<script>
/**
 * 職員朝礼伝達システム - Frontend Logic (v7.0)
 */

// =============================================================================
// グローバル変数
// =============================================================================

let currentDate = new Date();
let currentData = {};
let staffList = [];
let modal = null;

// =============================================================================
// 定数定義
// =============================================================================

const CONFIG = {
  ROOMS: ['選択1', '選択2', '選択3', '選択4', 'PC室', '会議室', '視聴覚室'],
  PERIODS: ['1限', '2限', '3限', '4限', '昼', '5限', '6限', '放課後'],
  DAYS_OF_WEEK: ['日', '月', '火', '水', '木', '金', '土'],
  TOAST_DURATION: 3000
};

const MESSAGE = {
  LOAD_SUCCESS: 'データを読み込みました',
  LOAD_ERROR: 'データの読み込みに失敗しました',
  SAVE_SUCCESS: 'データを保存しました',
  SAVE_ERROR: 'データの保存に失敗しました',
  DELETE_SUCCESS: 'データを削除しました',
  DELETE_ERROR: 'データの削除に失敗しました',
  COPY_SUCCESS: 'コピーしました',
  COPY_ERROR: 'コピーに失敗しました'
};

// =============================================================================
// 初期化
// =============================================================================

window.onload = function() {
  initializeApp();
};

/**
 * アプリケーションの初期化
 */
function initializeApp() {
  try {
    modal = new bootstrap.Modal(document.getElementById('entryModal'));
    setToday();
  } catch (e) {
    console.error('初期化エラー:', e);
    showErrorToast('アプリケーションの初期化に失敗しました');
  }
}

// =============================================================================
// 日付操作
// =============================================================================

/**
 * 今日の日付に設定
 */
function setToday() {
  currentDate = new Date();
  updateDatePicker();
  loadData();
}

/**
 * 日付を変更
 * @param {number} delta - 変更する日数（+1: 翌日, -1: 前日）
 */
function changeDate(delta) {
  currentDate.setDate(currentDate.getDate() + delta);
  updateDatePicker();
  loadData();
}

/**
 * 日付ピッカーを更新
 */
function updateDatePicker() {
  const y = currentDate.getFullYear();
  const m = ('0' + (currentDate.getMonth() + 1)).slice(-2);
  const d = ('0' + currentDate.getDate()).slice(-2);
  document.getElementById('datePicker').value = `${y}-${m}-${d}`;
}

// 日付ピッカーのイベントリスナー
document.addEventListener('DOMContentLoaded', function() {
  const datePicker = document.getElementById('datePicker');
  if (datePicker) {
    datePicker.addEventListener('change', function() {
      currentDate = new Date(this.value);
      loadData();
    });
  }
});

// =============================================================================
// ユーティリティ関数
// =============================================================================

/**
 * HTMLエスケープ（XSS対策）
 * @param {string} text - エスケープする文字列
 * @returns {string} エスケープされた文字列
 */
function escapeHtml(text) {
  if (!text) return '';
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.toString().replace(/[&<>"']/g, m => map[m]);
}

/**
 * ローディング表示の切り替え
 * @param {boolean} show - 表示するかどうか
 */
function showLoading(show) {
  const loading = document.getElementById('loading');
  if (loading) {
    loading.style.display = show ? 'flex' : 'none';
  }
}

// =============================================================================
// トーストメッセージ
// =============================================================================

/**
 * 成功メッセージを表示
 * @param {string} message - 表示するメッセージ
 */
function showSuccessToast(message) {
  showToast(message, 'success');
}

/**
 * エラーメッセージを表示
 * @param {string} message - 表示するメッセージ
 */
function showErrorToast(message) {
  showToast(message, 'error');
}

/**
 * トーストメッセージを表示
 * @param {string} message - 表示するメッセージ
 * @param {string} type - メッセージタイプ（'success' or 'error'）
 */
function showToast(message, type = 'info') {
  // 既存のトーストを削除
  const existingToast = document.getElementById('customToast');
  if (existingToast) {
    existingToast.remove();
  }

  // トーストHTML作成
  const bgColor = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
  const icon = type === 'success' ? 'check-circle-fill' : type === 'error' ? 'exclamation-triangle-fill' : 'info-circle-fill';

  const toastHTML = `
    <div id="customToast" class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999;">
      <div class="toast show ${bgColor} text-white" role="alert">
        <div class="toast-body d-flex align-items-center">
          <i class="bi bi-${icon} me-2"></i>
          <span>${message}</span>
          <button type="button" class="btn-close btn-close-white ms-auto" onclick="this.closest('.toast').remove()"></button>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', toastHTML);

  // 自動的に削除
  setTimeout(() => {
    const toast = document.getElementById('customToast');
    if (toast) {
      toast.remove();
    }
  }, CONFIG.TOAST_DURATION);
}

// =============================================================================
// データ読み込み
// =============================================================================

/**
 * データを読み込む
 */
function loadData() {
  try {
    showLoading(true);
    const dateStr = document.getElementById('datePicker').value;
    console.log('Loading data for date:', dateStr);

    google.script.run
      .withSuccessHandler(onDataLoaded)
      .withFailureHandler(onFailure)
      .getData(dateStr);
  } catch (e) {
    console.error('loadData error:', e);
    showErrorToast(MESSAGE.LOAD_ERROR);
    showLoading(false);
  }
}

/**
 * データ読み込み成功時の処理
 * @param {string} json - JSON形式のデータ
 */
function onDataLoaded(json) {
  try {
    const data = JSON.parse(json);
    currentData = data;
    staffList = data.staff;

    console.log('Data loaded successfully:', {
      daily: data.daily.length,
      trips: data.trips.length,
      leaves: data.leaves.length,
      meetings: data.meetings.length
    });

    // 日付表示を更新
    const dateStr = document.getElementById('datePicker').value;
    const dayOfWeek = CONFIG.DAYS_OF_WEEK[currentDate.getDay()];
    document.getElementById('displayDate').textContent = `${dateStr} (${dayOfWeek})`;

    // 各セクションをレンダリング
    renderDailyList(data.daily);
    renderTripList(data.trips);
    renderLeaveList(data.leaves);
    renderMeetings(data.meetings);
    renderAnnouncements('announceStaffList', data.announcements_staff, 'announce');
    renderAnnouncements('announceStudentList', data.announcements_student, 'announce');
    renderRoomMatrix(data.reservations);

    // カウント表示を更新
    document.getElementById('badgeTrip').textContent = data.counts.trip;
    document.getElementById('badgeLeave').textContent = data.counts.leave;
    document.getElementById('badgeMeeting').textContent = data.counts.meeting;

    showLoading(false);
  } catch (e) {
    console.error('onDataLoaded error:', e);
    showErrorToast(MESSAGE.LOAD_ERROR);
    showLoading(false);
  }
}

/**
 * データ読み込み失敗時の処理
 * @param {Error} error - エラーオブジェクト
 */
function onFailure(error) {
  console.error('Server error:', error);
  showErrorToast(`${MESSAGE.LOAD_ERROR}: ${error.message || error}`);
  showLoading(false);
}

// =============================================================================
// レンダリング関数
// =============================================================================

/**
 * 行事リストをレンダリング
 * @param {Array} items - 行事データの配列
 */
function renderDailyList(items) {
  try {
    const list = document.getElementById('dailyList');
    list.innerHTML = '';
    document.getElementById('dailyCount').textContent = items.length + '件';

    if (!items || items.length === 0) {
      list.innerHTML = '<li class="list-group-item text-muted text-center py-4">予定はありません</li>';
      return;
    }

    // 時刻でソート
    items.sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));

    items.forEach(d => {
      const timeHtml = d.time ? `<span class="badge bg-primary me-2">${escapeHtml(d.time)}</span>` : '';
      const noteHtml = d.note ? `<br><small class="text-muted"><i class="bi bi-info-circle me-1"></i>${escapeHtml(d.note)}</small>` : '';
      const contentSafe = escapeHtml(d.content);

      list.innerHTML += `
        <li class="list-group-item d-flex justify-content-between align-items-start">
          <div class="me-auto">
            <div class="fw-bold fs-5">${timeHtml}${contentSafe}</div>
            ${noteHtml}
          </div>
          <button class="btn btn-sm text-danger opacity-50" onclick="deleteItem('${d.id}', 'daily', '${contentSafe}')" title="削除">
            <i class="bi bi-trash"></i>
          </button>
        </li>
      `;
    });
  } catch (e) {
    console.error('renderDailyList error:', e);
  }
}

/**
 * 出張リストをレンダリング
 * @param {Array} items - 出張データの配列
 */
function renderTripList(items) {
  const list = document.getElementById('tripList');
  list.innerHTML = items.length ? '' : '<li class="list-group-item text-muted small py-2">予定なし</li>';

  items.forEach(t => {
    list.innerHTML += `
      <li class="list-group-item">
        <div class="d-flex justify-content-between">
          <strong>${escapeHtml(t.staff_name)}</strong>
          <span class="badge bg-success rounded-pill align-self-center">${escapeHtml(t.time)}</span>
        </div>
        <div class="small text-muted text-truncate">${escapeHtml(t.location)} / ${escapeHtml(t.purpose)}</div>
      </li>
    `;
  });
}

/**
 * 休暇リストをレンダリング
 * @param {Array} items - 休暇データの配列
 */
function renderLeaveList(items) {
  const list = document.getElementById('leaveList');
  list.innerHTML = items.length ? '' : '<li class="list-group-item text-muted small py-2">予定なし</li>';

  items.forEach(l => {
    const badgeClass = l.type === '年休' ? 'bg-primary' : l.type === '夏季休暇' ? 'bg-info text-dark' : 'bg-secondary';
    list.innerHTML += `
      <li class="list-group-item">
        <div class="d-flex justify-content-between">
          <strong>${escapeHtml(l.staff_name)}</strong>
          <span class="badge ${badgeClass} rounded-pill align-self-center">${escapeHtml(l.type)}</span>
        </div>
        <div class="small text-muted">${escapeHtml(l.time)}</div>
      </li>
    `;
  });
}

/**
 * 伝達事項をレンダリング
 * @param {string} id - 要素ID
 * @param {Array} items - 伝達事項データの配列
 * @param {string} cat - カテゴリ
 */
function renderAnnouncements(id, items, cat) {
  try {
    const el = document.getElementById(id);
    el.innerHTML = items.length ? '' : '<li class="list-group-item text-muted text-center py-3">なし</li>';

    items.forEach(a => {
      const priorityHtml = a.priority === '◎' ? '<span class="priority-high">重要</span>' : '';
      el.innerHTML += `
        <li class="list-group-item">
          <div class="d-flex justify-content-between mb-1">
            <div>
              <span class="badge bg-light text-dark border me-2">${escapeHtml(a.target)}</span>
              <small class="text-muted">報告: ${escapeHtml(a.reporter)}</small>
            </div>
            <button class="btn btn-sm text-danger opacity-25 p-0" onclick="deleteItem('${a.id}', '${cat}', 'この伝達事項')" title="削除">
              <i class="bi bi-x-circle-fill"></i>
            </button>
          </div>
          <div class="fs-5">${priorityHtml}${escapeHtml(a.content)}</div>
        </li>
      `;
    });
  } catch (e) {
    console.error('renderAnnouncements error:', e);
  }
}

/**
 * 会議リストをレンダリング
 * @param {Array} items - 会議データの配列
 */
function renderMeetings(items) {
  try {
    const el = document.getElementById('meetingList');
    el.innerHTML = items.length ? '' : '<tr><td colspan="3" class="text-center text-muted small py-2">予定なし</td></tr>';

    items.forEach(m => {
      const rowClass = m.is_fixed ? 'fixed-meeting' : '';
      el.innerHTML += `
        <tr class="${rowClass}">
          <td>${escapeHtml(m.name)}</td>
          <td>${escapeHtml(m.time)}</td>
          <td>${escapeHtml(m.place)}</td>
        </tr>
      `;
    });
  } catch (e) {
    console.error('renderMeetings error:', e);
  }
}

/**
 * 教室予約マトリックスをレンダリング
 * @param {Array} reservations - 予約データの配列
 */
function renderRoomMatrix(reservations) {
  try {
    const thead = document.querySelector('#roomTable thead');
    const tbody = document.querySelector('#roomTable tbody');

    // ヘッダー行を作成
    let headHtml = '<tr><th class="bg-light"></th>';
    CONFIG.PERIODS.forEach(p => {
      headHtml += `<th>${escapeHtml(p)}</th>`;
    });
    thead.innerHTML = headHtml + '</tr>';

    // ボディ行を作成
    let bodyHtml = '';
    CONFIG.ROOMS.forEach(room => {
      bodyHtml += `<tr><th class="bg-light">${escapeHtml(room)}</th>`;

      CONFIG.PERIODS.forEach(period => {
        const nr = reservations.find(r => r.room === room && r.period === period && !r.is_fixed);
        const fr = reservations.find(r => r.room === room && r.period === period && r.is_fixed);

        if (nr) {
          // 通常予約（固定設定の上書き）
          const reserver = nr.reserver ? `<div style="font-size:0.75em; opacity:0.8; line-height:1.2;">${escapeHtml(nr.reserver)}</div>` : '';
          if (nr.content === '中止') {
            bodyHtml += `<td class="cell-cancelled" onclick="deleteOverride('${nr.id}', '中止')" title="クリックして削除"><small>中止</small>${reserver}</td>`;
          } else {
            bodyHtml += `<td class="cell-occupied" onclick="deleteOverride('${nr.id}', '${escapeHtml(nr.content)}')" title="${escapeHtml(nr.content)} (クリックして削除)"><div>${escapeHtml(nr.content)}</div>${reserver}</td>`;
          }
        } else if (fr) {
          // 固定予約
          const reserver = fr.reserver ? `<div style="font-size:0.75em; opacity:0.8; line-height:1.2;">${escapeHtml(fr.reserver)}</div>` : '';
          bodyHtml += `<td class="cell-fixed" onclick="openFixedRoomModal('${escapeHtml(room)}', '${escapeHtml(period)}', '${escapeHtml(fr.content)}', '${escapeHtml(fr.reserver || '')}')" title="${escapeHtml(fr.content)} (固定設定)"><div>${escapeHtml(fr.content)}</div>${reserver}</td>`;
        } else {
          // 空き
          bodyHtml += `<td onclick="openRoomModal('${escapeHtml(room)}', '${escapeHtml(period)}')" title="クリックして予約"></td>`;
        }
      });

      bodyHtml += '</tr>';
    });

    tbody.innerHTML = bodyHtml;
  } catch (e) {
    console.error('renderRoomMatrix error:', e);
  }
}

// Modals
function getStaffOptionsHtml() { return '<option value="">選択</option>' + staffList.map(s => `<option value="${s.name}">${s.name}</option>`).join(''); }

function openModal(cat, typeArg) {
  document.getElementById('entryCategory').value = cat;
  document.getElementById('announceType').value = typeArg || '';
  const staffOpts = getStaffOptionsHtml();
  let html = '';

  if (cat === 'daily') {
    document.getElementById('modalTitle').innerText = '行事の追加';
    html = `<div class="mb-3"><label>時間</label><input type="text" id="inputTime" class="form-control" placeholder="例: 10:00, 終日"></div><div class="mb-3"><label>内容</label><input type="text" id="inputContent" class="form-control" placeholder="例: スクールカウンセラー来校"></div><div class="mb-3"><label>備考</label><input type="text" id="inputNote" class="form-control" placeholder="例: 応接室"></div>`;
  } else if (cat === 'announce') {
    const defTarget = typeArg === '生徒' ? '全学年' : '全職員';
    html = `<div class="mb-3"><label>重要度</label><div class="btn-group w-100"><input type="radio" class="btn-check" name="prio" id="p1" value="・" checked><label class="btn btn-outline-secondary" for="p1">通常</label><input type="radio" class="btn-check" name="prio" id="p2" value="◎"><label class="btn btn-outline-danger" for="p2">重要</label></div></div><div class="mb-3"><label>対象</label><input type="text" id="inputTarget" class="form-control" value="${defTarget}"></div><div class="mb-3"><label>内容</label><textarea id="inputContent" class="form-control" rows="3"></textarea></div><div class="mb-3"><label>報告者</label><select id="inputReporter" class="form-select">${staffOpts}</select></div>`;
    document.getElementById('modalTitle').innerText = `伝達事項（${typeArg||''}）`;
  } else if (cat === 'trip') {
    document.getElementById('modalTitle').innerText = '出張登録';
    html = `<div class="mb-3"><label>職員</label><select id="inputStaff" class="form-select">${staffOpts}</select></div><div class="mb-3"><label>用務</label><input type="text" id="inputPurpose" class="form-control"></div><div class="mb-3"><label>場所</label><input type="text" id="inputLocation" class="form-control"></div><div class="mb-3"><label>時間</label><input type="text" id="inputTime" class="form-control" value="1日"></div><div class="mb-3"><label>備考</label><input type="text" id="inputNote" class="form-control"></div>`;
  } else if (cat === 'leave') {
    document.getElementById('modalTitle').innerText = '休暇登録';
    html = `<div class="mb-3"><label>職員</label><select id="inputStaff" class="form-select">${staffOpts}</select></div><div class="mb-3"><label>種別</label><select id="inputType" class="form-select"><option>年休</option><option>振休</option><option>時間休</option><option>病休</option><option>夏季休暇</option><option>その他</option></select></div><div class="mb-3"><label>時間</label><input type="text" id="inputTime" class="form-control" value="1日"></div>`;
  } else if (cat === 'meeting') {
    document.getElementById('modalTitle').innerText = '会議登録';
    html = `<div class="mb-3"><label>会議名</label><input type="text" id="inputName" class="form-control"></div><div class="mb-3"><label>時間</label><input type="text" id="inputTime" class="form-control" value="放課後"></div><div class="mb-3"><label>場所</label><input type="text" id="inputPlace" class="form-control" value="会議室"></div>`;
  }
  document.getElementById('formContent').innerHTML = html;
  modal.show();
}

function openRoomModal(room, period) {
  document.getElementById('entryCategory').value = 'room'; document.getElementById('modalTitle').innerText = `${room} - ${period}`;
  document.getElementById('formContent').innerHTML = `<input type="hidden" id="inputRoom" value="${room}"><input type="hidden" id="inputPeriod" value="${period}"><div class="mb-3"><label>授業・内容</label><input type="text" id="inputContent" class="form-control" placeholder="例: 3-5 情報"></div><div class="mb-3"><label>予約者</label><select id="inputReserver" class="form-select">${getStaffOptionsHtml()}</select></div>`;
  modal.show();
}

function openFixedRoomModal(room, period, original, owner) {
  document.getElementById('entryCategory').value = 'room'; document.getElementById('modalTitle').innerText = `${room} - ${period} (固定設定)`;
  document.getElementById('formContent').innerHTML = `<div class="alert alert-secondary py-2 mb-3"><small>通常設定:</small><br><strong>${original}</strong> <small>(${owner||''})</small></div><p class="small text-muted">本日分の変更を行います。</p><input type="hidden" id="inputRoom" value="${room}"><input type="hidden" id="inputPeriod" value="${period}"><div class="mb-3"><label>変更内容</label><div class="input-group"><input type="text" id="inputContent" class="form-control" value="${original}"><button type="button" class="btn btn-outline-danger" onclick="setCancelContent()">中止にする</button></div></div><div class="mb-3"><label>変更予約者</label><select id="inputReserver" class="form-select">${getStaffOptionsHtml()}</select></div>`;
  modal.show();
}
function setCancelContent() { document.getElementById('inputContent').value = '中止'; }

// =============================================================================
// フォーム送信・削除
// =============================================================================

/**
 * フォームを送信
 */
function submitForm() {
  try {
    const cat = document.getElementById('entryCategory').value;
    const data = { date: document.getElementById('datePicker').value };

    // カテゴリごとにデータを収集
    if (cat === 'daily') {
      data.time = document.getElementById('inputTime')?.value || '';
      data.content = document.getElementById('inputContent')?.value || '';
      data.note = document.getElementById('inputNote')?.value || '';

      if (!data.content.trim()) {
        showErrorToast('内容を入力してください');
        return;
      }
    } else if (cat === 'announce') {
      data.type = document.getElementById('announceType').value;
      data.priority = document.querySelector('input[name="prio"]:checked')?.value || '・';
      data.target = document.getElementById('inputTarget')?.value || '';
      data.content = document.getElementById('inputContent')?.value || '';
      data.reporter = document.getElementById('inputReporter')?.value || '';

      if (!data.content.trim() || !data.reporter) {
        showErrorToast('内容と報告者を入力してください');
        return;
      }
    } else if (cat === 'trip') {
      data.staff = document.getElementById('inputStaff')?.value || '';
      data.purpose = document.getElementById('inputPurpose')?.value || '';
      data.location = document.getElementById('inputLocation')?.value || '';
      data.time = document.getElementById('inputTime')?.value || '1日';
      data.note = document.getElementById('inputNote')?.value || '';

      if (!data.staff || !data.purpose || !data.location) {
        showErrorToast('職員、用務、場所を入力してください');
        return;
      }
    } else if (cat === 'leave') {
      data.staff = document.getElementById('inputStaff')?.value || '';
      data.type = document.getElementById('inputType')?.value || '';
      data.time = document.getElementById('inputTime')?.value || '1日';

      if (!data.staff || !data.type) {
        showErrorToast('職員と種別を入力してください');
        return;
      }
    } else if (cat === 'meeting') {
      data.name = document.getElementById('inputName')?.value || '';
      data.time = document.getElementById('inputTime')?.value || '放課後';
      data.place = document.getElementById('inputPlace')?.value || '会議室';

      if (!data.name.trim()) {
        showErrorToast('会議名を入力してください');
        return;
      }
    } else if (cat === 'room') {
      data.room = document.getElementById('inputRoom')?.value || '';
      data.period = document.getElementById('inputPeriod')?.value || '';
      data.content = document.getElementById('inputContent')?.value || '';
      data.reserver = document.getElementById('inputReserver')?.value || '';

      if (!data.content.trim()) {
        showErrorToast('授業・内容を入力してください');
        return;
      }
    }

    showLoading(true);
    modal.hide();

    console.log('Submitting form:', { category: cat, data });

    google.script.run
      .withSuccessHandler(function() {
        showSuccessToast(MESSAGE.SAVE_SUCCESS);
        loadData();
      })
      .withFailureHandler(function(error) {
        console.error('Save error:', error);
        showErrorToast(`${MESSAGE.SAVE_ERROR}: ${error.message || error}`);
        showLoading(false);
      })
      .saveData(cat, data);

  } catch (e) {
    console.error('submitForm error:', e);
    showErrorToast(MESSAGE.SAVE_ERROR);
    showLoading(false);
  }
}

/**
 * データを削除
 * @param {string} id - データID
 * @param {string} category - カテゴリ
 * @param {string} name - 表示名
 */
function deleteItem(id, category, name) {
  if (!confirm(`「${name}」を削除しますか？`)) return;

  showLoading(true);
  console.log('Deleting item:', { id, category, name });

  google.script.run
    .withSuccessHandler(function() {
      showSuccessToast(MESSAGE.DELETE_SUCCESS);
      loadData();
    })
    .withFailureHandler(function(error) {
      console.error('Delete error:', error);
      showErrorToast(`${MESSAGE.DELETE_ERROR}: ${error.message || error}`);
      showLoading(false);
    })
    .deleteEvent(id, category);
}

/**
 * 教室予約の上書きを削除（固定設定に戻す）
 * @param {string} id - データID
 * @param {string} content - 内容
 */
function deleteOverride(id, content) {
  if (!confirm(`「${content}」の設定を削除し、固定設定に戻しますか？`)) return;

  showLoading(true);
  console.log('Deleting override:', { id, content });

  google.script.run
    .withSuccessHandler(function() {
      showSuccessToast(MESSAGE.DELETE_SUCCESS);
      loadData();
    })
    .withFailureHandler(function(error) {
      console.error('Delete override error:', error);
      showErrorToast(`${MESSAGE.DELETE_ERROR}: ${error.message || error}`);
      showLoading(false);
    })
    .deleteEvent(id, 'room');
}

/**
 * 行事情報をクリップボードにコピー
 */
function copyDailyInfo() {
  try {
    let text = `【${document.getElementById('displayDate').innerText}】\n`;
    const items = currentData.daily || [];

    if (items.length === 0) {
      text += "予定なし";
    } else {
      items.forEach(d => {
        const time = d.time ? d.time + ' ' : '';
        const note = d.note ? '(' + d.note + ')' : '';
        text += `・${time}${d.content} ${note}\n`;
      });
    }

    navigator.clipboard.writeText(text)
      .then(() => {
        showSuccessToast(MESSAGE.COPY_SUCCESS);
      })
      .catch((error) => {
        console.error('Copy error:', error);
        showErrorToast(MESSAGE.COPY_ERROR);
      });
  } catch (e) {
    console.error('copyDailyInfo error:', e);
    showErrorToast(MESSAGE.COPY_ERROR);
  }
}
</script>