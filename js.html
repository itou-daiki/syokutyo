<script>
let currentDate = new Date();
let currentData = {};
let staffList = [];
const modal = new bootstrap.Modal(document.getElementById('entryModal'));

const ROOMS = ['選択1', '選択2', '選択3', '選択4', 'PC室', '会議室', '視聴覚室'];
const PERIODS = ['1限', '2限', '3限', '4限', '昼', '5限', '6限', '放課後'];

window.onload = function() { setToday(); };

function setToday() { currentDate = new Date(); updateDatePicker(); loadData(); }
function changeDate(delta) { currentDate.setDate(currentDate.getDate() + delta); updateDatePicker(); loadData(); }
function updateDatePicker() {
  const y = currentDate.getFullYear(), m = ('0' + (currentDate.getMonth() + 1)).slice(-2), d = ('0' + currentDate.getDate()).slice(-2);
  document.getElementById('datePicker').value = `${y}-${m}-${d}`;
}
document.getElementById('datePicker').addEventListener('change', function() { currentDate = new Date(this.value); loadData(); });

function loadData() {
  showLoading(true);
  google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onFailure).getData(document.getElementById('datePicker').value);
}

function onDataLoaded(json) {
  const data = JSON.parse(json);
  currentData = data;
  staffList = data.staff;

  const days = ['日', '月', '火', '水', '木', '金', '土'];
  document.getElementById('displayDate').textContent = `${document.getElementById('datePicker').value} (${days[currentDate.getDay()]})`;
  
  // 行事リスト描画
  renderDailyList(data.daily);

  renderList('tripList', data.trips, t => `<li class="list-group-item"><div class="d-flex justify-content-between"><strong>${t.staff_name}</strong><span class="badge bg-success rounded-pill align-self-center">${t.time}</span></div><div class="small text-muted text-truncate">${t.location} / ${t.purpose}</div></li>`);
  renderList('leaveList', data.leaves, l => `<li class="list-group-item"><div class="d-flex justify-content-between"><strong>${l.staff_name}</strong><span class="badge ${l.type==='年休'?'bg-primary':(l.type==='夏季休暇'?'bg-info text-dark':'bg-secondary')} rounded-pill align-self-center">${l.type}</span></div><div class="small text-muted">${l.time}</div></li>`);
  renderMeetings(data.meetings);
  
  renderAnnouncements('announceStaffList', data.announcements_staff, 'announce');
  renderAnnouncements('announceStudentList', data.announcements_student, 'announce');
  
  renderRoomMatrix(data.reservations);

  document.getElementById('badgeTrip').textContent = data.counts.trip;
  document.getElementById('badgeLeave').textContent = data.counts.leave;
  document.getElementById('badgeMeeting').textContent = data.counts.meeting;
  showLoading(false);
}

// 行事リスト
function renderDailyList(items) {
  const list = document.getElementById('dailyList');
  list.innerHTML = '';
  document.getElementById('dailyCount').textContent = items.length + '件';
  if (!items || items.length === 0) {
    list.innerHTML = '<li class="list-group-item text-muted text-center py-4">予定はありません</li>';
    return;
  }
  // 時刻がある場合は並び替え
  items.sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));
  items.forEach(d => {
    const timeHtml = d.time ? `<span class="badge bg-primary me-2">${d.time}</span>` : '';
    const noteHtml = d.note ? `<br><small class="text-muted"><i class="bi bi-info-circle me-1"></i>${d.note}</small>` : '';
    list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-start"><div class="me-auto"><div class="fw-bold fs-5">${timeHtml}${d.content}</div>${noteHtml}</div><button class="btn btn-sm text-danger opacity-50" onclick="deleteItem('${d.id}', 'daily', '${d.content}')"><i class="bi bi-trash"></i></button></li>`;
  });
}

function renderList(id, items, fn) {
  const el = document.getElementById(id); el.innerHTML = items.length ? '' : '<li class="list-group-item text-muted small py-2">予定なし</li>';
  items.forEach(i => el.innerHTML += fn(i));
}

// 伝達事項 (削除ボタン付)
function renderAnnouncements(id, items, cat) {
  const el = document.getElementById(id); el.innerHTML = items.length ? '' : '<li class="list-group-item text-muted text-center py-3">なし</li>';
  items.forEach(a => el.innerHTML += `<li class="list-group-item"><div class="d-flex justify-content-between mb-1"><div><span class="badge bg-light text-dark border me-2">${a.target}</span><small class="text-muted">報告: ${a.reporter}</small></div><button class="btn btn-sm text-danger opacity-25 p-0" onclick="deleteItem('${a.id}', '${cat}', 'この伝達事項')"><i class="bi bi-x-circle-fill"></i></button></div><div class="fs-5">${a.priority==='◎'?'<span class="priority-high">重要</span>':''}${a.content}</div></li>`);
}

function renderMeetings(items) {
  const el = document.getElementById('meetingList'); el.innerHTML = items.length ? '' : '<tr><td colspan="3" class="text-center text-muted small py-2">予定なし</td></tr>';
  items.forEach(m => el.innerHTML += `<tr class="${m.is_fixed?'fixed-meeting':''}"><td>${m.name}</td><td>${m.time}</td><td>${m.place}</td></tr>`);
}

function renderRoomMatrix(reservations) {
  const thead = document.querySelector('#roomTable thead'), tbody = document.querySelector('#roomTable tbody');
  let headHtml = '<tr><th class="bg-light"></th>';
  PERIODS.forEach(p => headHtml += `<th>${p}</th>`);
  thead.innerHTML = headHtml + '</tr>';
  let bodyHtml = '';
  ROOMS.forEach(room => {
    bodyHtml += `<tr><th class="bg-light">${room}</th>`;
    PERIODS.forEach(period => {
      const nr = reservations.find(r => r.room === room && r.period === period && !r.is_fixed);
      const fr = reservations.find(r => r.room === room && r.period === period && r.is_fixed);
      if (nr) {
        const rh = nr.reserver ? `<div style="font-size:0.75em; opacity:0.8; line-height:1.2;">${nr.reserver}</div>` : '';
        bodyHtml += nr.content === '中止' ? `<td class="cell-cancelled" onclick="deleteOverride('${nr.id}', '${nr.content}')"><small>中止</small>${rh}</td>` : `<td class="cell-occupied" onclick="deleteOverride('${nr.id}', '${nr.content}')" title="${nr.content}"><div>${nr.content}</div>${rh}</td>`;
      } else if (fr) {
        const rh = fr.reserver ? `<div style="font-size:0.75em; opacity:0.8; line-height:1.2;">${fr.reserver}</div>` : '';
        bodyHtml += `<td class="cell-fixed" onclick="openFixedRoomModal('${room}', '${period}', '${fr.content}', '${fr.reserver||''}')" title="${fr.content}"><div>${fr.content}</div>${rh}</td>`;
      } else {
        bodyHtml += `<td onclick="openRoomModal('${room}', '${period}')"></td>`;
      }
    });
    bodyHtml += '</tr>';
  });
  tbody.innerHTML = bodyHtml;
}

// Modals
function getStaffOptionsHtml() { return '<option value="">選択</option>' + staffList.map(s => `<option value="${s.name}">${s.name}</option>`).join(''); }

function openModal(cat, typeArg) {
  document.getElementById('entryCategory').value = cat;
  document.getElementById('announceType').value = typeArg || '';
  const staffOpts = getStaffOptionsHtml();
  let html = '';

  if (cat === 'daily') {
    document.getElementById('modalTitle').innerText = '行事の追加';
    html = `<div class="mb-3"><label>時間</label><input type="text" id="inputTime" class="form-control" placeholder="例: 10:00, 終日"></div><div class="mb-3"><label>内容</label><input type="text" id="inputContent" class="form-control" placeholder="例: スクールカウンセラー来校"></div><div class="mb-3"><label>備考</label><input type="text" id="inputNote" class="form-control" placeholder="例: 応接室"></div>`;
  } else if (cat === 'announce') {
    const defTarget = typeArg === '生徒' ? '全学年' : '全職員';
    html = `<div class="mb-3"><label>重要度</label><div class="btn-group w-100"><input type="radio" class="btn-check" name="prio" id="p1" value="・" checked><label class="btn btn-outline-secondary" for="p1">通常</label><input type="radio" class="btn-check" name="prio" id="p2" value="◎"><label class="btn btn-outline-danger" for="p2">重要</label></div></div><div class="mb-3"><label>対象</label><input type="text" id="inputTarget" class="form-control" value="${defTarget}"></div><div class="mb-3"><label>内容</label><textarea id="inputContent" class="form-control" rows="3"></textarea></div><div class="mb-3"><label>報告者</label><select id="inputReporter" class="form-select">${staffOpts}</select></div>`;
    document.getElementById('modalTitle').innerText = `伝達事項（${typeArg||''}）`;
  } else if (cat === 'trip') {
    document.getElementById('modalTitle').innerText = '出張登録';
    html = `<div class="mb-3"><label>職員</label><select id="inputStaff" class="form-select">${staffOpts}</select></div><div class="mb-3"><label>用務</label><input type="text" id="inputPurpose" class="form-control"></div><div class="mb-3"><label>場所</label><input type="text" id="inputLocation" class="form-control"></div><div class="mb-3"><label>時間</label><input type="text" id="inputTime" class="form-control" value="1日"></div><div class="mb-3"><label>備考</label><input type="text" id="inputNote" class="form-control"></div>`;
  } else if (cat === 'leave') {
    document.getElementById('modalTitle').innerText = '休暇登録';
    html = `<div class="mb-3"><label>職員</label><select id="inputStaff" class="form-select">${staffOpts}</select></div><div class="mb-3"><label>種別</label><select id="inputType" class="form-select"><option>年休</option><option>振休</option><option>時間休</option><option>病休</option><option>夏季休暇</option><option>その他</option></select></div><div class="mb-3"><label>時間</label><input type="text" id="inputTime" class="form-control" value="1日"></div>`;
  } else if (cat === 'meeting') {
    document.getElementById('modalTitle').innerText = '会議登録';
    html = `<div class="mb-3"><label>会議名</label><input type="text" id="inputName" class="form-control"></div><div class="mb-3"><label>時間</label><input type="text" id="inputTime" class="form-control" value="放課後"></div><div class="mb-3"><label>場所</label><input type="text" id="inputPlace" class="form-control" value="会議室"></div>`;
  }
  document.getElementById('formContent').innerHTML = html;
  modal.show();
}

function openRoomModal(room, period) {
  document.getElementById('entryCategory').value = 'room'; document.getElementById('modalTitle').innerText = `${room} - ${period}`;
  document.getElementById('formContent').innerHTML = `<input type="hidden" id="inputRoom" value="${room}"><input type="hidden" id="inputPeriod" value="${period}"><div class="mb-3"><label>授業・内容</label><input type="text" id="inputContent" class="form-control" placeholder="例: 3-5 情報"></div><div class="mb-3"><label>予約者</label><select id="inputReserver" class="form-select">${getStaffOptionsHtml()}</select></div>`;
  modal.show();
}

function openFixedRoomModal(room, period, original, owner) {
  document.getElementById('entryCategory').value = 'room'; document.getElementById('modalTitle').innerText = `${room} - ${period} (固定設定)`;
  document.getElementById('formContent').innerHTML = `<div class="alert alert-secondary py-2 mb-3"><small>通常設定:</small><br><strong>${original}</strong> <small>(${owner||''})</small></div><p class="small text-muted">本日分の変更を行います。</p><input type="hidden" id="inputRoom" value="${room}"><input type="hidden" id="inputPeriod" value="${period}"><div class="mb-3"><label>変更内容</label><div class="input-group"><input type="text" id="inputContent" class="form-control" value="${original}"><button type="button" class="btn btn-outline-danger" onclick="setCancelContent()">中止にする</button></div></div><div class="mb-3"><label>変更予約者</label><select id="inputReserver" class="form-select">${getStaffOptionsHtml()}</select></div>`;
  modal.show();
}
function setCancelContent() { document.getElementById('inputContent').value = '中止'; }

function submitForm() {
  const cat = document.getElementById('entryCategory').value, data = { date: document.getElementById('datePicker').value };
  if (cat === 'daily') { data.time = document.getElementById('inputTime').value; data.content = document.getElementById('inputContent').value; data.note = document.getElementById('inputNote').value; }
  else if (cat === 'announce') { data.type = document.getElementById('announceType').value; data.priority = document.querySelector('input[name="prio"]:checked').value; data.target = document.getElementById('inputTarget').value; data.content = document.getElementById('inputContent').value; data.reporter = document.getElementById('inputReporter').value; }
  else if (cat === 'trip') { data.staff = document.getElementById('inputStaff').value; data.purpose = document.getElementById('inputPurpose').value; data.location = document.getElementById('inputLocation').value; data.time = document.getElementById('inputTime').value; data.note = document.getElementById('inputNote').value; }
  else if (cat === 'leave') { data.staff = document.getElementById('inputStaff').value; data.type = document.getElementById('inputType').value; data.time = document.getElementById('inputTime').value; }
  else if (cat === 'meeting') { data.name = document.getElementById('inputName').value; data.time = document.getElementById('inputTime').value; data.place = document.getElementById('inputPlace').value; }
  else if (cat === 'room') { data.room = document.getElementById('inputRoom').value; data.period = document.getElementById('inputPeriod').value; data.content = document.getElementById('inputContent').value; data.reserver = document.getElementById('inputReserver').value; }
  showLoading(true); modal.hide();
  google.script.run.withSuccessHandler(loadData).withFailureHandler(onFailure).saveData(cat, data);
}

function deleteItem(id, category, name) {
  if(!confirm(`「${name}」を削除しますか？`)) return;
  showLoading(true);
  google.script.run.withSuccessHandler(loadData).withFailureHandler(onFailure).deleteEvent(id, category);
}

function deleteOverride(id, content) {
  if(!confirm(`「${content}」の設定を削除し、固定設定に戻しますか？`)) return;
  showLoading(true);
  google.script.run.withSuccessHandler(loadData).withFailureHandler(onFailure).deleteEvent(id, 'room');
}

function copyDailyInfo() {
  let text = `【${document.getElementById('displayDate').innerText}】\n`;
  const items = currentData.daily || [];
  if(items.length === 0) text += "予定なし";
  else items.forEach(d => text += `・${d.time ? d.time + ' ' : ''}${d.content} ${d.note ? '('+d.note+')' : ''}\n`);
  navigator.clipboard.writeText(text).then(() => alert('コピーしました'));
}

function showLoading(b) { document.getElementById('loading').style.display = b ? 'flex' : 'none'; }
function onFailure(e) { alert('Error: ' + e); showLoading(false); }
</script>